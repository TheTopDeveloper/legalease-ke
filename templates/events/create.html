{% extends 'base.html' %}

{% block title %}Add Event - Kenya Law Assistant{% endblock %}

{% block styles %}
{{ super() }}
<style>
    .time-slot {
        cursor: pointer;
        transition: background-color 0.2s;
    }
    
    .time-slot:hover {
        background-color: #e9ecef;
    }
    
    .time-slot.selected {
        background-color: #cfe2ff;
        border-color: #9ec5fe;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-lg-8">
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-light">
                    <div class="d-flex justify-content-between align-items-center">
                        <h4 class="mb-0">Add New Event</h4>
                        <div>
                            <a href="{{ url_for('events.calendar') }}" class="btn btn-outline-secondary btn-sm">
                                <i class="fas fa-calendar-alt"></i> Calendar
                            </a>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <form method="post" action="{{ url_for('events.create') }}">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="title" class="form-label">Title <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="title" name="title" required>
                            </div>
                            <div class="col-md-6">
                                <label for="event_type" class="form-label">Event Type <span class="text-danger">*</span></label>
                                <select class="form-select" id="event_type" name="event_type" required>
                                    <option value="">-- Select Type --</option>
                                    {% for event_type in event_types %}
                                    <option value="{{ event_type }}">{{ event_type }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="start_time" class="form-label">Start Date & Time <span class="text-danger">*</span></label>
                                <input type="datetime-local" class="form-control" id="start_time" name="start_time" required>
                            </div>
                            <div class="col-md-6">
                                <label for="end_time" class="form-label">End Date & Time</label>
                                <input type="datetime-local" class="form-control" id="end_time" name="end_time">
                            </div>
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="location" class="form-label">Location</label>
                                <input type="text" class="form-control" id="location" name="location">
                            </div>
                            <div class="col-md-6">
                                <label for="case_id" class="form-label">Related Case</label>
                                <select class="form-select" id="case_id" name="case_id">
                                    <option value="">-- No Case --</option>
                                    {% for case in cases %}
                                    <option value="{{ case.id }}">{{ case.title }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="priority" class="form-label">Priority</label>
                                <select class="form-select" id="priority" name="priority">
                                    <option value="1">High</option>
                                    <option value="2" selected>Medium</option>
                                    <option value="3">Low</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="reminder_time" class="form-label">Send Reminder Before</label>
                                <select class="form-select" id="reminder_time" name="reminder_time">
                                    <option value="1">1 hour</option>
                                    <option value="3">3 hours</option>
                                    <option value="12">12 hours</option>
                                    <option value="24" selected>24 hours</option>
                                    <option value="48">2 days</option>
                                    <option value="72">3 days</option>
                                    <option value="168">1 week</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="is_all_day" name="is_all_day">
                                    <label class="form-check-label" for="is_all_day">
                                        All Day Event
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="is_recurring" name="is_recurring">
                                    <label class="form-check-label" for="is_recurring">
                                        Recurring Event
                                    </label>
                                </div>
                            </div>
                        </div>
                        
                        <div id="recurring-options" class="row mb-3" style="display: none;">
                            <div class="col-md-6">
                                <label for="recurrence_pattern" class="form-label">Recurrence Pattern</label>
                                <select class="form-select" id="recurrence_pattern" name="recurrence_pattern">
                                    <option value="daily">Daily</option>
                                    <option value="weekly">Weekly</option>
                                    <option value="biweekly">Bi-weekly</option>
                                    <option value="monthly">Monthly</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="recurrence_end_date" class="form-label">End Date</label>
                                <input type="date" class="form-control" id="recurrence_end_date" name="recurrence_end_date">
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="description" class="form-label">Description</label>
                            <textarea class="form-control" id="description" name="description" rows="3"></textarea>
                        </div>
                        
                        <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                            <a href="{{ url_for('events.calendar') }}" class="btn btn-outline-secondary me-md-2">Cancel</a>
                            <button type="submit" class="btn btn-primary">Save Event</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        
        <!-- Sidebar -->
        <div class="col-lg-4">
            <!-- Suggested Times -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-light">
                    <h5 class="mb-0">Suggested Times</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label for="suggested-date" class="form-label">Select Date</label>
                        <input type="date" class="form-control" id="suggested-date">
                    </div>
                    <div class="mb-3">
                        <label for="suggested-duration" class="form-label">Duration</label>
                        <select class="form-select" id="suggested-duration">
                            <option value="30">30 minutes</option>
                            <option value="60" selected>1 hour</option>
                            <option value="90">1.5 hours</option>
                            <option value="120">2 hours</option>
                        </select>
                    </div>
                    <button type="button" id="find-times-btn" class="btn btn-outline-primary w-100">
                        Find Available Times
                    </button>
                    
                    <div id="suggested-times-container" class="mt-3" style="display: none;">
                        <h6 class="border-bottom pb-2 mb-2">Available Times</h6>
                        <div id="suggested-times" class="list-group">
                            <!-- Suggested times will be loaded here -->
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Tips -->
            <div class="card shadow-sm">
                <div class="card-header bg-light">
                    <h5 class="mb-0">Tips</h5>
                </div>
                <div class="card-body">
                    <ul class="small">
                        <li class="mb-2">Court events are typically scheduled in the morning hours.</li>
                        <li class="mb-2">Client meetings are best scheduled with a buffer time before and after.</li>
                        <li class="mb-2">For recurring events, ensure you specify an end date to prevent excessive events.</li>
                        <li class="mb-2">High priority events will be highlighted in the calendar.</li>
                        <li class="mb-2">SMS reminders will be sent to your registered phone number.</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Toggle recurring options based on checkbox
        const isRecurringCheckbox = document.getElementById('is_recurring');
        const recurringOptions = document.getElementById('recurring-options');
        
        isRecurringCheckbox.addEventListener('change', function() {
            recurringOptions.style.display = this.checked ? 'flex' : 'none';
        });
        
        // Toggle time inputs when all-day is checked
        const isAllDayCheckbox = document.getElementById('is_all_day');
        const startTimeInput = document.getElementById('start_time');
        const endTimeInput = document.getElementById('end_time');
        
        isAllDayCheckbox.addEventListener('change', function() {
            if (this.checked) {
                // Store current values
                startTimeInput.dataset.time = startTimeInput.value;
                endTimeInput.dataset.time = endTimeInput.value;
                
                // Set to beginning/end of day
                if (startTimeInput.value) {
                    const datePart = startTimeInput.value.split('T')[0];
                    startTimeInput.value = datePart + 'T00:00';
                }
                
                if (endTimeInput.value) {
                    const datePart = endTimeInput.value.split('T')[0];
                    endTimeInput.value = datePart + 'T23:59';
                }
            } else {
                // Restore previous values if they exist
                if (startTimeInput.dataset.time) {
                    startTimeInput.value = startTimeInput.dataset.time;
                }
                
                if (endTimeInput.dataset.time) {
                    endTimeInput.value = endTimeInput.dataset.time;
                }
            }
        });
        
        // Handle event type selection - default end time for court events
        const eventTypeSelect = document.getElementById('event_type');
        
        eventTypeSelect.addEventListener('change', function() {
            const selectedType = this.value;
            if (selectedType === 'Court Appearance' || selectedType === 'Hearing' || selectedType === 'Mention') {
                // Default to high priority
                document.getElementById('priority').value = '1';
                
                // Default to morning if no time set
                if (startTimeInput.value) {
                    const datePart = startTimeInput.value.split('T')[0];
                    const timePart = startTimeInput.value.split('T')[1];
                    
                    // If no time set or time is not in the morning, default to 9:00
                    if (!timePart || parseInt(timePart.split(':')[0]) >= 12) {
                        startTimeInput.value = datePart + 'T09:00';
                    }
                    
                    // Set end time 2 hours later for court events
                    if (startTimeInput.value) {
                        const date = new Date(startTimeInput.value);
                        date.setHours(date.getHours() + 2);
                        
                        const endYear = date.getFullYear();
                        const endMonth = String(date.getMonth() + 1).padStart(2, '0');
                        const endDay = String(date.getDate()).padStart(2, '0');
                        const endHours = String(date.getHours()).padStart(2, '0');
                        const endMinutes = String(date.getMinutes()).padStart(2, '0');
                        
                        endTimeInput.value = `${endYear}-${endMonth}-${endDay}T${endHours}:${endMinutes}`;
                    }
                }
            }
        });
        
        // Suggested times functionality
        const findTimesBtn = document.getElementById('find-times-btn');
        const suggestedDateInput = document.getElementById('suggested-date');
        const suggestedDurationSelect = document.getElementById('suggested-duration');
        const suggestedTimesContainer = document.getElementById('suggested-times-container');
        const suggestedTimesList = document.getElementById('suggested-times');
        
        // Set default date to today
        const today = new Date();
        const year = today.getFullYear();
        const month = String(today.getMonth() + 1).padStart(2, '0');
        const day = String(today.getDate()).padStart(2, '0');
        suggestedDateInput.value = `${year}-${month}-${day}`;
        
        findTimesBtn.addEventListener('click', async function() {
            const date = suggestedDateInput.value;
            const duration = suggestedDurationSelect.value;
            const eventType = eventTypeSelect.value;
            const caseId = document.getElementById('case_id').value;
            
            if (!date) {
                alert('Please select a date');
                return;
            }
            
            try {
                const response = await fetch('/events/suggest-times', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        date,
                        duration,
                        event_type: eventType,
                        case_id: caseId
                    }),
                });
                
                const data = await response.json();
                
                if (data.error) {
                    alert('Error: ' + data.error);
                    return;
                }
                
                // Display suggested times
                suggestedTimesContainer.style.display = 'block';
                suggestedTimesList.innerHTML = '';
                
                if (data.available_slots && data.available_slots.length > 0) {
                    data.available_slots.forEach(slot => {
                        const listItem = document.createElement('a');
                        listItem.href = '#';
                        listItem.className = 'list-group-item list-group-item-action time-slot';
                        listItem.textContent = slot.formatted_time;
                        listItem.dataset.startTime = slot.start_time;
                        listItem.dataset.endTime = slot.end_time;
                        
                        listItem.addEventListener('click', function(e) {
                            e.preventDefault();
                            
                            // Remove selected class from all slots
                            document.querySelectorAll('.time-slot').forEach(el => {
                                el.classList.remove('selected');
                            });
                            
                            // Add selected class to this slot
                            this.classList.add('selected');
                            
                            // Set the selected time in the form
                            const selectedDate = date;
                            const startTime = `${selectedDate}T${this.dataset.startTime}`;
                            const endTime = `${selectedDate}T${this.dataset.endTime}`;
                            
                            document.getElementById('start_time').value = startTime;
                            document.getElementById('end_time').value = endTime;
                        });
                        
                        suggestedTimesList.appendChild(listItem);
                    });
                } else {
                    suggestedTimesList.innerHTML = '<div class="list-group-item text-center">No available times found</div>';
                }
            } catch (error) {
                console.error('Error:', error);
                alert('An error occurred while fetching available times');
            }
        });
    });
</script>
{% endblock %}